<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>HRTminder Config</title>
    <style>
        body {
          font-family: sans-serif;
          padding: 20px;
          background-color: #380703;
          color: #ffffff;
        }
        .container { max-width: 400px; margin: auto; }
        .section-title {
          font-weight: bold;
          margin-top: 20px;
          border-bottom: 1px solid rgba(255,255,255,0.15);
          padding-bottom: 5px;
          color: #ffffff;
        }

        select, input[type="text"], input[type="date"], input[type="time"], input[type="number"] {
          width: 100%;
          padding: 12px;
          margin-top: 8px;
          background: rgba(255,255,255,0.06);
          color: #ffffff;
          border: 1px solid rgba(255,255,255,0.12);
          border-radius: 4px;
          box-sizing: border-box;
        }
        option { color: #000; }

        label { cursor: pointer; color:#ffffff; }
        .field-row { display:flex; align-items:center; gap:8px; margin-top:6px; }

        input[type="radio"] { width: 18px; height: 18px; margin-right: 8px; accent-color: #ffffff; }

        button#saveButton { margin-top: 24px; padding: 12px; width: 100%; background-color: #007AFF; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .small-note { font-size:0.90em; color: rgba(255,255,255,0.85); }
        .setting-row {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
          margin-top: 12px;
        }
        .setting-row .label { font-weight:600; color:#fff; white-space:nowrap; margin-right:12px; }
        .setting-row .controls { display:flex; gap:8px; align-items:center; }

        .radio-inline { display:inline-flex; align-items:center; gap:6px; font-size:0.95em; color:#ffffff; }

        .controls.compact { gap:6px; flex-wrap:wrap; justify-content:flex-end; }
        .owm-row { margin-top: 12px; display:flex; gap:8px; align-items:flex-start; }
        .owm-row input[type="text"] { flex: 1 1 auto; }
        .owm-test-button {
          padding: 10px 12px;
          background: rgba(255,255,255,0.08);
          color: #fff;
          border: 1px solid rgba(255,255,255,0.12);
          border-radius: 6px;
          cursor: pointer;
        }
        .owm-status { margin-top: 8px; font-size: 0.95em; }
        .owm-status.ok { color: #7CFC00; }
        .owm-status.fail { color: #ff6666; }
        .owm-status.testing { color: #ffd700; }

        .took-button {
          margin-top:10px;
          padding:10px;
          width:100%;
          background:#2e8b57;
          color:#fff;
          border:none;
          border-radius:6px;
          font-weight:bold;
          cursor:pointer;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>settings</h1>

    <div class="section-title">Bottom Display Format</div>
    <select id="bottom_display_mode">
        <option value="battery_only">minimalist freak option</option>
        <option value="battery_solar">Battery Percentage &amp; Sunrise/Sunset</option>
        <option value="battery_high_low">Battery Percentage &amp; Daily High/Low</option>
        <option value="battery_moon">Battery Percentage &amp; Moon Phase</option>
        <option value="battery_tz">Battery Percentage &amp; Second Timezone</option>
        <option value="battery_beat">Battery Percentage &amp; @beat time</option>
    </select>

    <div id="tzContainer" style="margin-top:12px; display:none;">
      <div class="section-title">Second Timezone</div>
      <select id="time_zone">
        <option value="UTC">UTC</option>
        <option value="America/New_York">Pittsburgh</option>
        <option value="America/Havana">Havana</option>
        <option value="America/Chicago">Chicago</option>
        <option value="America/Denver">Denver</option>
        <option value="America/Los_Angeles">Seattle</option>
        <option value="America/Anchorage">Alaska (Anchorage)</option>
        <option value="America/Honolulu">Honolulu</option>
        <option value="Europe/London">London</option>
        <option value="Europe/Paris">Paris</option>
        <option value="Europe/Berlin">Berlin</option>
        <option value="Asia/Gaza">Palestine (Gaza/West Bank)</option>
        <option value="Asia/Tokyo">Tokyo</option>
        <option value="Asia/Hong_Kong">Hong Kong</option>
        <option value="Asia/Shanghai">Beijing</option>
        <option value="Asia/Singapore">Singapore</option>
        <option value="Asia/Kolkata">India (Kolkata)</option>
        <option value="Asia/Seoul">Seoul</option>
        <option value="Asia/Pyongyang">Pyongyang</option>
        <option value="Australia/Sydney">Sydney / Melbourne</option>
        <option value="Antarctica/McMurdo">Antarctica (McMurdo)</option>
      </select>
    </div>

    <div class="section-title">Weather Configuration</div>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <div style="margin-top:12px;">
        <label style="color:#fff; display:block; margin-bottom:6px;">OpenWeatherMap API key</label>
        <div class="owm-row">
          <input type="text" id="owm_api_key" placeholder="Enter your OpenWeatherMap API key" />
          <button id="owm_test_button" class="owm-test-button" type="button">Test key</button>
        </div>
        <div id="owm_status" class="owm-status"></div>
        <div class="small-note">Leave blank to use the bundled default key (not recommended for public builds).</div>
      </div>

      <div class="setting-row" id="temp-format-row">
        <div class="label" style="font-weight:400;">Units</div>
        <div class="controls">
          <label class="radio-inline"><input type="radio" name="unit_pref" value="Fahrenheit" id="unit_f">°F</label>
          <label class="radio-inline"><input type="radio" name="unit_pref" value="Celsius" id="unit_c">°C</label>
        </div>
      </div>
    </div>

    <div class="section-title">HRT Widget Configuration</div>
    <div style="display:flex;flex-direction:column;gap:8px;">

      <label style="margin-top:14px;">My hormones are in the form of...</label>
      <select id="med_method_select">
        <option value="Injection">an injection</option>
        <option value="Pills">pills</option>
        <option value="Patch">a patch</option>
        <option value="HRT">HRT</option>
        <option value="Custom">Custom...</option>
      </select>
      <input type="text" id="med_method_custom" placeholder="Custom method" style="display:none; margin-top:6px;"/>

      <label style="margin-top:8px;">I take my hormones every:</label>
      <div class="field-row">
        <input type="number" id="med_interval_days" min="1" value="7" style="width:80px" />
        <select id="med_interval_unit" style="width:120px;">
          <option value="days">days</option>
          <option value="hours">hours</option>
        </select>
      </div>

      <label style="margin-top:8px;">beginning on:</label>
      <input type="date" id="med_start_date" />

      <label style="margin-top:8px;">at:</label>
      <input type="time" id="med_start_time" />

      <label style="margin-top:8px;">Countdown unit (display):</label>
      <select id="med_unit_pref">
        <option value="0">Auto (days or hours)</option>
        <option value="1">Hours</option>
        <option value="2">Days</option>
      </select>

      <div class="setting-row" id="hrt-nag-row">
        <div class="label">HRT nag</div>
        <div class="controls">
          <label class="radio-inline"><input type="radio" name="med_hrt_nag" value="on" id="med_hrt_nag_on">On</label>
          <label class="radio-inline"><input type="radio" name="med_hrt_nag" value="off" id="med_hrt_nag_off">Off</label>
        </div>
      </div>

      <!-- Alert duration container: shown only when HRT nag is ON -->
      <div id="alertDurationContainer" style="margin-top:8px; display:none;">
        <label style="font-weight:600; color:#fff; display:block; margin-bottom:6px;">Alert duration</label>
        <select id="med_hrt_alert_duration" style="margin-top:6px;">
          <option value="0">None</option>
          <option value="60">1 minute</option>
          <option value="300">5 minutes</option>
          <option value="1800">30 minutes</option>
          <option value="3600">1 hour</option>
          <option value="7200">2 hours</option>
          <option value="21600">6 hours</option>
        </select>
        <div class="small-note">with HRT nag enabled, this determines how long the watch says "Time for your hormones!" before showing the dose as overdue.</div>
      </div>

      <!-- Guilt setting - shown only when HRT nag is ON -->
      <div id="guiltContainer" style="margin-top:8px; display:none;">
        <div class="setting-row" style="margin-top:0;">
          <div class="label">Guilt</div>
          <div class="controls">
            <label class="radio-inline"><input type="radio" name="med_hrt_guilt" value="on" id="med_hrt_guilt_on">On</label>
            <label class="radio-inline"><input type="radio" name="med_hrt_guilt" value="off" id="med_hrt_guilt_off">Off</label>
          </div>
        </div>
        <div class="small-note">when enabled, and the dose is overdue, the watch will yell at you. not literally, Pebbles don't have speakers. just on the watchface.</div>
      </div>

      <div class="setting-row" id="show-next-row">
        <div class="label">Show date &amp; time of next dose</div>
        <div class="controls">
          <label class="radio-inline"><input type="radio" name="med_show_next" value="on" id="med_show_next_on">On</label>
          <label class="radio-inline"><input type="radio" name="med_show_next" value="off" id="med_show_next_off">Off</label>
        </div>
      </div>

      <div class="setting-row" id="widget-font-row">
        <div class="label">Widget font</div>
        <div class="controls">
          <label class="radio-inline"><input type="radio" name="med_widget_font" value="U001" id="widget_font_u001">U001</label>
          <label class="radio-inline"><input type="radio" name="med_widget_font" value="DINish" id="widget_font_dinish">DINish</label>
        </div>
      </div>

      <!-- "I took my meds!" button (closes config and sends hrt_advance = true) -->
      <button id="took_meds_button" class="took-button" type="button">I took my meds!</button>

    </div>

    <div class="section-title">Miscellaneous</div>
    <div style="display:flex;flex-direction:column;gap:8px;">

      <!-- Font (main) — single-line with right-aligned controls -->
      <div class="setting-row" id="main-font-row" style="margin-top:12px;">
        <div class="label">Font</div>
        <div class="controls compact">
          <label class="radio-inline"><input type="radio" name="font_family" value="U001" id="font_u001">U001</label>
          <label class="radio-inline"><input type="radio" name="font_family" value="Inter" id="font_inter">Inter</label>
          <label class="radio-inline"><input type="radio" name="font_family" value="Jost" id="font_jost">Jost*</label>
          <label class="radio-inline"><input type="radio" name="font_family" value="DINish" id="font_dinish">DINish</label>
        </div>
      </div>

      <!-- Color mode (single-line) -->
      <div class="setting-row" id="color-mode-row" style="margin-top:8px;">
        <div class="label">Color mode</div>
        <div class="controls">
          <label class="radio-inline"><input type="radio" name="color_mode" value="dark" id="color_dark">Dark</label>
          <label class="radio-inline"><input type="radio" name="color_mode" value="light" id="color_light">Light</label>
        </div>
      </div>

      <!-- Time format (single-line) -->
      <div class="setting-row" id="time-format-row" style="margin-top:8px;">
        <div class="label">Time format</div>
        <div class="controls">
          <label class="radio-inline"><input type="radio" name="time_format" value="12" id="time12">12-hour</label>
          <label class="radio-inline"><input type="radio" name="time_format" value="24" id="time24">24-hour</label>
        </div>
      </div>

      <div class="setting-row" id="buzz-hour-row" style="margin-top:8px;">
        <div class="label">Vibrate hourly</div>
        <div class="controls">
          <label class="radio-inline"><input type="radio" name="buzz_hour" value="on" id="buzz_hour_on">On</label>
          <label class="radio-inline"><input type="radio" name="buzz_hour" value="off" id="buzz_hour_off">Off</label>
        </div>
      </div>

      <div class="setting-row" id="buzz-disconnect-row" style="margin-top:8px;">
        <div class="label">Vibrate on disconnect</div>
        <div class="controls">
          <label class="radio-inline"><input type="radio" name="buzz_disconnect" value="on" id="buzz_disconnect_on">On</label>
          <label class="radio-inline"><input type="radio" name="buzz_disconnect" value="off" id="buzz_disconnect_off">Off</label>
        </div>
      </div>

    </div>

    <button id="saveButton">save & exit</button>
</div>

<script>
    function getParam(name, defaultValue) {
        var res = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
        return res ? decodeURIComponent(res[1]) : defaultValue;
    }

    function updateTzVisibility() {
      var mode = document.getElementById('bottom_display_mode').value;
      document.getElementById('tzContainer').style.display = (mode === 'battery_tz') ? 'block' : 'none';
    }

    function updateAlertVisibility() {
      var on = !!(document.getElementById('med_hrt_nag_on') && document.getElementById('med_hrt_nag_on').checked);
      var c = document.getElementById('alertDurationContainer');
      var g = document.getElementById('guiltContainer');
      if (c) c.style.display = on ? 'block' : 'none';
      if (g) g.style.display = on ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
      var sel = document.getElementById('med_method_select');
      sel.addEventListener('change', function(e){
        var v = e.target.value;
        document.getElementById('med_method_custom').style.display = (v === 'Custom') ? 'block' : 'none';
      });

      var nagRadios = document.querySelectorAll('input[name="med_hrt_nag"]');
      nagRadios.forEach(function(r) {
        r.addEventListener('change', updateAlertVisibility);
      });

      document.getElementById('owm_test_button').addEventListener('click', function() {
        testOwmKey();
      });

      document.getElementById('took_meds_button').addEventListener('click', function() {
        var configuration = gatherConfiguration();
        configuration.hrt_advance = true;
        try {
          if (configuration.med_hrt_nag) localStorage.setItem('med_hrt_nag', 'true');
          else localStorage.setItem('med_hrt_nag', 'false');
          localStorage.setItem('med_hrt_alert_duration', String(configuration.med_hrt_alert_duration || 0));
          localStorage.setItem('med_hrt_guilt', configuration.med_hrt_guilt ? 'true' : 'false');
        } catch (e){}
        var location = getParam('return_to', 'pebblejs://close#');
        document.location = location + encodeURIComponent(JSON.stringify(configuration));
      });
    });

    function gatherConfiguration() {
      var methodSel = document.getElementById('med_method_select').value;
      var methodVal = methodSel === 'Custom' ? (document.getElementById('med_method_custom').value || '').trim() : methodSel;
      var widgetFontVal = (document.querySelector('input[name="med_widget_font"]:checked') || {}).value || 'U001';
      var showNextVal = (document.querySelector('input[name="med_show_next"]:checked') || {}).value === 'on';
      var buzzHourVal = (document.querySelector('input[name="buzz_hour"]:checked') || {}).value === 'on';
      var buzzDisconnectVal = (document.querySelector('input[name="buzz_disconnect"]:checked') || {}).value === 'on';
      var unitPrefVal = (document.querySelector('input[name="unit_pref"]:checked') || {}).value || 'Fahrenheit';
      var medHrtNag = (document.querySelector('input[name="med_hrt_nag"]:checked') || {}).value === 'on';
      var alertDur = parseInt(document.getElementById('med_hrt_alert_duration').value || '0', 10) || 0;
      var medGuilt = (document.querySelector('input[name="med_hrt_guilt"]:checked') || {}).value === 'on';

      return {
          'unit_pref': unitPrefVal,
          'date_format': document.getElementById('date_format') ? document.getElementById('date_format').value : 'US',
          'buzz_hour': buzzHourVal,
          'buzz_disconnect': buzzDisconnectVal,
          'bottom_display_mode': document.getElementById('bottom_display_mode').value,
          'time_zone': document.getElementById('time_zone').value,
          'time_format': document.querySelector('input[name="time_format"]:checked') ? document.querySelector('input[name="time_format"]:checked').value : '12',
          'color_mode': document.querySelector('input[name="color_mode"]:checked') ? document.querySelector('input[name="color_mode"]:checked').value : 'dark',
          'font_family': document.querySelector('input[name="font_family"]:checked') ? document.querySelector('input[name="font_family"]:checked').value : 'U001',
          'med_method': methodVal,
          'med_interval_days': document.getElementById('med_interval_days').value,
          'med_interval_unit': document.getElementById('med_interval_unit').value,
          'med_start_date': document.getElementById('med_start_date').value,
          'med_start_time': document.getElementById('med_start_time').value,
          'med_unit_pref': document.getElementById('med_unit_pref').value,
          'med_widget_font': widgetFontVal,
          'med_show_next': showNextVal,
          'med_hrt_nag': medHrtNag,
          'med_hrt_alert_duration': alertDur,
          'med_hrt_guilt': medGuilt,
          'owm_api_key': document.getElementById('owm_api_key').value || ''
      };
    }

    function testOwmKey() {
      var btn = document.getElementById('owm_test_button');
      var status = document.getElementById('owm_status');
      var key = document.getElementById('owm_api_key').value || '';

      if (!key || key.trim().length === 0) {
        status.className = 'owm-status fail';
        status.textContent = 'Please enter an API key to test.';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Testing...';
      status.className = 'owm-status testing';
      status.textContent = 'Testing key...';

      var xhr = new XMLHttpRequest();
      var testUrl = 'https://api.openweathermap.org/data/2.5/weather?q=London&units=metric&appid=' + encodeURIComponent(key);
      xhr.open('GET', testUrl, true);
      xhr.timeout = 8000;
      xhr.onreadystatechange = function () {
        if (xhr.readyState !== 4) return;
        btn.disabled = false;
        btn.textContent = 'Test key';
        if (xhr.status === 200) {
          status.className = 'owm-status ok';
          try {
            var j = JSON.parse(xhr.responseText);
            var place = j.name || 'London';
            status.textContent = 'Success — key works (' + place + ').';
          } catch (e) {
            status.textContent = 'Success — key works.';
          }
        } else if (xhr.status === 401) {
          status.className = 'owm-status fail';
          status.textContent = 'Invalid API key (401).';
        } else {
          status.className = 'owm-status fail';
          try {
            var j = JSON.parse(xhr.responseText);
            if (j && j.message) status.textContent = 'Failed: ' + j.message;
            else status.textContent = 'Failed (status ' + xhr.status + ').';
          } catch (e) {
            status.textContent = 'Failed (status ' + xhr.status + ').';
          }
        }
      };
      xhr.ontimeout = function() {
        btn.disabled = false;
        btn.textContent = 'Test key';
        status.className = 'owm-status fail';
        status.textContent = 'Request timed out. Check your connection.';
      };
      xhr.onerror = function() {
        btn.disabled = false;
        btn.textContent = 'Test key';
        status.className = 'owm-status fail';
        status.textContent = 'Network error while testing key.';
      };
      try {
        xhr.send();
      } catch (e) {
        btn.disabled = false;
        btn.textContent = 'Test key';
        status.className = 'owm-status fail';
        status.textContent = 'Error sending request: ' + e;
      }
    }

    window.onload = function() {
        document.getElementById('bottom_display_mode').value = getParam('bottom_display_mode', localStorage.getItem('bottom_display_mode') || 'battery_solar');

        var savedTz = getParam('time_zone', localStorage.getItem('time_zone') || '');
        var tzSelect = document.getElementById('time_zone');
        tzSelect.value = savedTz ? savedTz : 'UTC';

        var savedMed = getParam('med_method', localStorage.getItem('med_method') || '');
        var known = ['Injection','Pills','Patch','HRT'];
        if (savedMed && known.indexOf(savedMed) >= 0) {
          document.getElementById('med_method_select').value = savedMed;
          document.getElementById('med_method_custom').value = '';
          document.getElementById('med_method_custom').style.display = 'none';
        } else if (savedMed) {
          document.getElementById('med_method_select').value = 'Custom';
          document.getElementById('med_method_custom').value = savedMed;
          document.getElementById('med_method_custom').style.display = 'block';
        } else {
          document.getElementById('med_method_select').value = 'Injection';
          document.getElementById('med_method_custom').value = '';
          document.getElementById('med_method_custom').style.display = 'none';
        }

        document.getElementById('med_interval_days').value = getParam('med_interval_days', localStorage.getItem('med_interval_days') || '7');
        document.getElementById('med_interval_unit').value = getParam('med_interval_unit', localStorage.getItem('med_interval_unit') || 'days');
        document.getElementById('med_start_date').value = getParam('med_start_date', localStorage.getItem('med_start_date') || '');
        document.getElementById('med_start_time').value = getParam('med_start_time', localStorage.getItem('med_start_time') || '');
        document.getElementById('med_unit_pref').value = getParam('med_unit_pref', localStorage.getItem('med_unit_pref') || '0');

        var savedWidgetFont = getParam('med_widget_font', localStorage.getItem('med_widget_font') || 'U001');
        if (savedWidgetFont === 'DINish') document.getElementById('widget_font_dinish').checked = true;
        else document.getElementById('widget_font_u001').checked = true;

        var savedShowNext = getParam('med_show_next', localStorage.getItem('med_show_next') || 'false');
        if (savedShowNext === 'true' || savedShowNext === 'on' || savedShowNext === '1') document.getElementById('med_show_next_on').checked = true;
        else document.getElementById('med_show_next_off').checked = true;

        var savedHrtNag = getParam('med_hrt_nag', localStorage.getItem('med_hrt_nag') || 'false');
        if (savedHrtNag === 'true' || savedHrtNag === 'on' || savedHrtNag === '1') document.getElementById('med_hrt_nag_on').checked = true;
        else document.getElementById('med_hrt_nag_off').checked = true;

        var savedAlert = getParam('med_hrt_alert_duration', localStorage.getItem('med_hrt_alert_duration') || '0');
        var sel = document.getElementById('med_hrt_alert_duration');
        if (sel) {
          var found = false;
          for (var i = 0; i < sel.options.length; i++) {
            if (sel.options[i].value === String(savedAlert)) { sel.selectedIndex = i; found = true; break; }
          }
          if (!found) sel.value = String(savedAlert);
        }

        // guilt
        var savedGuilt = getParam('med_hrt_guilt', localStorage.getItem('med_hrt_guilt') || 'false');
        if (savedGuilt === 'true' || savedGuilt === 'on' || savedGuilt === '1') document.getElementById('med_hrt_guilt_on').checked = true;
        else document.getElementById('med_hrt_guilt_off').checked = true;

        var savedBuzzHour = getParam('buzz_hour', localStorage.getItem('buzz_hour') || 'true');
        if (savedBuzzHour === 'false' || savedBuzzHour === '0') {
          document.getElementById('buzz_hour_off').checked = true;
        } else {
          document.getElementById('buzz_hour_on').checked = true;
        }

        var savedBuzzDisc = getParam('buzz_disconnect', localStorage.getItem('buzz_disconnect') || 'true');
        if (savedBuzzDisc === 'false' || savedBuzzDisc === '0') {
          document.getElementById('buzz_disconnect_off').checked = true;
        } else {
          document.getElementById('buzz_disconnect_on').checked = true;
        }

        updateAlertVisibility();

        var savedFont = getParam('font_family', localStorage.getItem('font_family') || 'U001');
        if (savedFont === 'Inter') document.getElementById('font_inter').checked = true;
        else if (savedFont === 'Jost') document.getElementById('font_jost').checked = true;
        else if (savedFont === 'DINish') document.getElementById('font_dinish').checked = true;
        else document.getElementById('font_u001').checked = true;

        var savedColor = getParam('color_mode', localStorage.getItem('color_mode') || 'dark');
        if (savedColor === 'light') document.getElementById('color_light').checked = true;
        else document.getElementById('color_dark').checked = true;

        var savedTimeFormat = getParam('time_format', localStorage.getItem('time_format') || '12');
        if (savedTimeFormat === '24') document.getElementById('time24').checked = true;
        else document.getElementById('time12').checked = true;

        var savedKey = getParam('owm_api_key', localStorage.getItem('owm_api_key') || '');
        document.getElementById('owm_api_key').value = savedKey;
        document.getElementById('owm_status').textContent = '';

        var savedUnit = getParam('unit_pref', localStorage.getItem('unit_pref') || 'Fahrenheit');
        if (savedUnit === 'Celsius') document.getElementById('unit_c').checked = true;
        else document.getElementById('unit_f').checked = true;

        updateTzVisibility();
        document.getElementById('bottom_display_mode').addEventListener('change', updateTzVisibility);
    };

    document.getElementById('saveButton').addEventListener('click', function() {
      var configuration = gatherConfiguration();
      try {
        localStorage.setItem('time_zone', configuration.time_zone);
        localStorage.setItem('time_format', configuration.time_format);
        localStorage.setItem('unit_pref', configuration.unit_pref);
        localStorage.setItem('date_format', configuration.date_format || 'US');
        localStorage.setItem('buzz_hour', configuration.buzz_hour ? 'true' : 'false');
        localStorage.setItem('buzz_disconnect', configuration.buzz_disconnect ? 'true' : 'false');
        localStorage.setItem('bottom_display_mode', configuration.bottom_display_mode);
        localStorage.setItem('color_mode', configuration.color_mode);
        localStorage.setItem('font_family', configuration.font_family);
        if (configuration.med_method) localStorage.setItem('med_method', configuration.med_method);
        if (configuration.med_interval_days) localStorage.setItem('med_interval_days', configuration.med_interval_days);
        if (configuration.med_interval_unit) localStorage.setItem('med_interval_unit', configuration.med_interval_unit);
        if (configuration.med_start_date) localStorage.setItem('med_start_date', configuration.med_start_date);
        if (configuration.med_start_time) localStorage.setItem('med_start_time', configuration.med_start_time);
        if (typeof configuration.med_unit_pref !== 'undefined') localStorage.setItem('med_unit_pref', configuration.med_unit_pref);
        if (configuration.med_widget_font) localStorage.setItem('med_widget_font', configuration.med_widget_font);
        localStorage.setItem('med_show_next', configuration.med_show_next ? 'true' : 'false');
        if (configuration.med_hrt_nag) localStorage.setItem('med_hrt_nag', 'true'); else localStorage.setItem('med_hrt_nag', 'false');
        localStorage.setItem('med_hrt_alert_duration', String(configuration.med_hrt_alert_duration || 0));
        localStorage.setItem('med_hrt_guilt', configuration.med_hrt_guilt ? 'true' : 'false');
        if (configuration.owm_api_key) localStorage.setItem('owm_api_key', configuration.owm_api_key);
        else localStorage.removeItem('owm_api_key');
      } catch (e) {}
      var location = getParam('return_to', 'pebblejs://close#');
      document.location = location + encodeURIComponent(JSON.stringify(configuration));
    });
</script>
</body>
</html>